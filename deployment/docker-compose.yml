version: "3.8"
services:
  fullnode:
    image: radixdlt/radixdlt-core:1.3.0
    profiles: ["fullnode"]
    init: true
    ports:
      - "127.0.0.1:3333:3333" # This allows you to connect to the Core API on localhost:3333
    cap_add:
      - NET_ADMIN
    deploy:
      restart_policy:
        condition: on-failure
    environment:
      RADIXDLT_LOG_LEVEL: "${FULLNODE_LOG_LEVEL}"
      RADIXDLT_NETWORK_ID: "${FULLNODE_NETWORK_ID}"
      RADIXDLT_NETWORK_SEEDS_REMOTE: "${FULLNODE_NETWORK_BOOTSTRAP_NODE}"
      RADIX_NODE_KEYSTORE_PASSWORD: "${FULLNODE_KEY_PASSWORD}"
      JAVA_OPTS: -server -Xmx1536m -XX:+HeapDumpOnOutOfMemoryError -XX:+UseCompressedOops -Djavax.net.ssl.trustStore=/etc/ssl/certs/java/cacerts -Djavax.net.ssl.trustStoreType=jks -Djava.security.egd=file:/dev/urandom -DLog4jContextSelector=org.apache.logging.log4j.core.async.AsyncLoggerContextSelector --enable-preview
      RADIXDLT_VALIDATOR_KEY_LOCATION: "/home/radixdlt/node-keystore.ks"
      RADIXDLT_API_PORT: 3333
      RADIXDLT_TRANSACTIONS_API_ENABLE: "true"
    volumes:
      -  "./container-volumes/fullnode/ledger:/home/radixdlt/RADIXDB"
      -  "./container-volumes/fullnode/keystore.ks:/home/radixdlt/node-keystore.ks"
      -  "./container-volumes/fullnode/logs:/home/radixdlt/logs"

  postgres_db:
    # See https://hub.docker.com/_/postgres for details about configuration
    image: "postgres:12-alpine"
    profiles: ["network-gateway-built", "network-gateway-image"]
    ports:
      - "127.0.0.1:5532:5432" # This allows you to connect to the database locally on port localhost:5532
    # The default shutdown mode for this container is SIGINT:
    # https://github.com/docker-library/postgres/blob/e483778176ca34bcbe83ee17000820d4f6e64c28/12/alpine/Dockerfile
    # This enables fast Shutdown mode - see eg https://www.postgresql.org/docs/10/server-shutdown.html
    stop_grace_period: 90s # Ensure the DB is allowed time to stop to prevent needing to recover on next start-up
    deploy:
      restart_policy:
        condition: on-failure
    volumes:
      - ./container-volumes/.postgresdata:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: "${POSTGRES_SUPERUSER}"
      POSTGRES_PASSWORD: "${POSTGRES_SUPERUSER_PASSWORD}"
      POSTGRES_DB: "${POSTGRES_DB_NAME}"
    healthcheck:
      test: pg_isready -U ${POSTGRES_SUPERUSER} -d ${POSTGRES_DB_NAME}
      interval: 10s
      timeout: 3s
      retries: 3

  database_migrations: # This is the base -- the _image and _built containers are defined below
    image: radixdlt/babylon-ng-postgres-migrations:2.0.0 # TODO use actual image
    profiles: ["NONE"]
    environment:
      APP__ConnectionStrings__MigrationsDbContext: "Host=postgres_db:5432;Database=${POSTGRES_DB_NAME};Username=${POSTGRES_SUPERUSER};Password=${POSTGRES_SUPERUSER_PASSWORD}"

  data_aggregator: # This is the base -- the _image and _built containers are defined below
    image: radixdlt/babylon-ng-data-aggregator:2.0.0
    profiles: ["NONE"]
    deploy:
      restart_policy:
        condition: on-failure
    ports:
      - "127.0.0.1:5207:80" # This allows you to connect to the API (for root and health checks) at http://localhost:5207
      - "127.0.0.1:1234:1234" # This allows you to connect to the metrics API at http://localhost:1234
    environment:
      # WIPE_DATABASE: "true"
      ASPNETCORE_URLS: "http://*:80" # Binds to 80 on all interfaces
      APP__CustomJsonConfigurationFilePath: "/home/radixdlt/network-gateway/config.json"
      APP__PrometheusMetricsPort: "1234"
      APP__MaxWaitForDbOnStartupMs: "${MAX_DB_WAIT_MS_ON_START}" # Wait for PostGres to boot up
      APP__ConnectionStrings__AggregatorDbContext: "Host=postgres_db:5432;Database=${POSTGRES_DB_NAME};Username=${POSTGRES_SUPERUSER};Password=${POSTGRES_SUPERUSER_PASSWORD}"
      APP__DataAggregator__Network__NetworkName: "${NETWORK_NAME}"
      APP__DataAggregator__Network__DisableCoreApiHttpsCertificateChecks: "${DISABLE_CORE_API_CERTIFICATE_CHECKS}"
      APP__DataAggregator__Network__CoreApiNodes__0__Name: "${NODE_0_NAME}"
      APP__DataAggregator__Network__CoreApiNodes__0__CoreApiAddress: "${NODE_0_CORE_API_ADDRESS}"
      APP__DataAggregator__Network__CoreApiNodes__0__CoreApiAuthorizationHeader: "${NODE_0_CORE_API_AUTHORIZATION_HEADER}"
      APP__DataAggregator__Network__CoreApiNodes__0__TrustWeighting: "1"
      APP__DataAggregator__Network__CoreApiNodes__0__Enabled: "${NODE_0_ENABLED}"
      APP__DataAggregator__Network__CoreApiNodes__1__Name: "${NODE_1_NAME}"
      APP__DataAggregator__Network__CoreApiNodes__1__CoreApiAddress: "${NODE_1_CORE_API_ADDRESS}"
      APP__DataAggregator__Network__CoreApiNodes__1__CoreApiAuthorizationHeader: "${NODE_1_CORE_API_AUTHORIZATION_HEADER}"
      APP__DataAggregator__Network__CoreApiNodes__1__TrustWeighting: "1"
      APP__DataAggregator__Network__CoreApiNodes__1__Enabled: "${NODE_1_ENABLED}"
      APP__DataAggregator__Network__CoreApiNodes__2__Name: "${NODE_2_NAME}"
      APP__DataAggregator__Network__CoreApiNodes__2__CoreApiAddress: "${NODE_2_CORE_API_ADDRESS}"
      APP__DataAggregator__Network__CoreApiNodes__2__CoreApiAuthorizationHeader: "${NODE_2_CORE_API_AUTHORIZATION_HEADER}"
      APP__DataAggregator__Network__CoreApiNodes__2__TrustWeighting: "1"
      APP__DataAggregator__Network__CoreApiNodes__2__Enabled: "${NODE_2_ENABLED}"
      APP__DataAggregator__Network__CoreApiNodes__3__Name: "${NODE_3_NAME}"
      APP__DataAggregator__Network__CoreApiNodes__3__CoreApiAddress: "${NODE_3_CORE_API_ADDRESS}"
      APP__DataAggregator__Network__CoreApiNodes__3__CoreApiAuthorizationHeader: "${NODE_3_CORE_API_AUTHORIZATION_HEADER}"
      APP__DataAggregator__Network__CoreApiNodes__3__TrustWeighting: "1"
      APP__DataAggregator__Network__CoreApiNodes__3__Enabled: "${NODE_3_ENABLED}"
      APP__DataAggregator__Network__CoreApiNodes__4__Name: "${NODE_4_NAME}"
      APP__DataAggregator__Network__CoreApiNodes__4__CoreApiAddress: "${NODE_4_CORE_API_ADDRESS}"
      APP__DataAggregator__Network__CoreApiNodes__4__CoreApiAuthorizationHeader: "${NODE_4_CORE_API_AUTHORIZATION_HEADER}"
      APP__DataAggregator__Network__CoreApiNodes__4__TrustWeighting: "1"
      APP__DataAggregator__Network__CoreApiNodes__4__Enabled: "${NODE_4_ENABLED}"
    volumes:
      - ./data-aggregator-fixed-configuration.json:/home/radixdlt/network-gateway/config.json

  gateway_api: # This is the base -- the _image and _built containers are defined below
    image: radixdlt/babylon-ng-gateway-api:2.0.0
    profiles: ["NONE"]
    ports:
      - "127.0.0.1:5308:80" # This allows you to connect to the API at http://localhost:5308
      - "127.0.0.1:1235:1235" # This allows you to connect to the metrics API at http://localhost:1235
    deploy:
      restart_policy:
        condition: on-failure
    environment:
      ASPNETCORE_URLS: "http://*:80" # Binds to 80 on all interfaces
      APP__CustomJsonConfigurationFilePath: "/home/radixdlt/network-gateway/config.json"
      APP__PrometheusMetricsPort: "1235"
      APP__MaxWaitForDbOnStartupMs: "${MAX_DB_WAIT_MS_ON_START}" # Wait for PostGres to boot up
      APP__EnableSwagger: "${ENABLE_SWAGGER}"
      APP__ConnectionStrings__ReadOnlyDbContext: "Host=postgres_db:5432;Database=${POSTGRES_DB_NAME};Username=${POSTGRES_SUPERUSER};Password=${POSTGRES_SUPERUSER_PASSWORD}"
      APP__ConnectionStrings__ReadWriteDbContext: "Host=postgres_db:5432;Database=${POSTGRES_DB_NAME};Username=${POSTGRES_SUPERUSER};Password=${POSTGRES_SUPERUSER_PASSWORD}"
      APP__GatewayApi__Endpoints_MaxPageSize: "${MAX_PAGE_SIZE}"
      APP__GatewayApi__AcceptableLedgerLag__PreventReadRequestsIfDbLedgerIsBehind: "${PREVENT_OUTDATED_READ_REQUESTS}"
      APP__GatewayApi__AcceptableLedgerLag__PreventConstructionRequestsIfDbLedgerIsBehind: "${PREVENT_OUTDATED_CONSTRUCTION_REQUESTS}"
      APP__GatewayApi__Network__NetworkName: "${NETWORK_NAME}"
      APP__GatewayApi__Network__DisableCoreApiHttpsCertificateChecks: "${DISABLE_CORE_API_CERTIFICATE_CHECKS}"
      APP__GatewayApi__Network__CoreApiNodes__0__Name: "${NODE_0_NAME}"
      APP__GatewayApi__Network__CoreApiNodes__0__CoreApiAddress: "${NODE_0_CORE_API_ADDRESS}"
      APP__GatewayApi__Network__CoreApiNodes__0__CoreApiAuthorizationHeader: "${NODE_0_CORE_API_AUTHORIZATION_HEADER}"
      APP__GatewayApi__Network__CoreApiNodes__0__RequestWeighting: "1"
      APP__GatewayApi__Network__CoreApiNodes__0__Enabled: "${NODE_0_ENABLED}"
      APP__GatewayApi__Network__CoreApiNodes__1__Name: "${NODE_1_NAME}"
      APP__GatewayApi__Network__CoreApiNodes__1__CoreApiAddress: "${NODE_1_CORE_API_ADDRESS}"
      APP__GatewayApi__Network__CoreApiNodes__1__CoreApiAuthorizationHeader: "${NODE_1_CORE_API_AUTHORIZATION_HEADER}"
      APP__GatewayApi__Network__CoreApiNodes__1__RequestWeighting: "1"
      APP__GatewayApi__Network__CoreApiNodes__1__Enabled: "${NODE_1_ENABLED}"
      APP__GatewayApi__Network__CoreApiNodes__2__Name: "${NODE_2_NAME}"
      APP__GatewayApi__Network__CoreApiNodes__2__CoreApiAddress: "${NODE_2_CORE_API_ADDRESS}"
      APP__GatewayApi__Network__CoreApiNodes__2__CoreApiAuthorizationHeader: "${NODE_2_CORE_API_AUTHORIZATION_HEADER}"
      APP__GatewayApi__Network__CoreApiNodes__2__RequestWeighting: "1"
      APP__GatewayApi__Network__CoreApiNodes__2__Enabled: "${NODE_2_ENABLED}"
      APP__GatewayApi__Network__CoreApiNodes__3__Name: "${NODE_3_NAME}"
      APP__GatewayApi__Network__CoreApiNodes__3__CoreApiAddress: "${NODE_3_CORE_API_ADDRESS}"
      APP__GatewayApi__Network__CoreApiNodes__3__CoreApiAuthorizationHeader: "${NODE_3_CORE_API_AUTHORIZATION_HEADER}"
      APP__GatewayApi__Network__CoreApiNodes__3__RequestWeighting: "1"
      APP__GatewayApi__Network__CoreApiNodes__3__Enabled: "${NODE_3_ENABLED}"
      APP__GatewayApi__Network__CoreApiNodes__4__Name: "${NODE_4_NAME}"
      APP__GatewayApi__Network__CoreApiNodes__4__CoreApiAddress: "${NODE_4_CORE_API_ADDRESS}"
      APP__GatewayApi__Network__CoreApiNodes__4__CoreApiAuthorizationHeader: "${NODE_4_CORE_API_AUTHORIZATION_HEADER}"
      APP__GatewayApi__Network__CoreApiNodes__4__RequestWeighting: "1"
      APP__GatewayApi__Network__CoreApiNodes__4__Enabled: "${NODE_4_ENABLED}"
    volumes:
      - ./gateway-api-fixed-configuration.json:/home/radixdlt/network-gateway/config.json

  database_migrations_image:
    # NB - image: is defined in the base data_aggregator
    extends:
      service: database_migrations
    profiles: ["network-gateway-image"]
    depends_on:
      postgres_db:
        condition: service_healthy

  data_aggregator_image:
    # NB - image: is defined in the base data_aggregator
    extends:
      service: data_aggregator
    profiles: ["network-gateway-image"]
    depends_on:
      database_migrations_image:
        condition: service_completed_successfully

  gateway_api_image:
    # NB - image: is defined in the base gateway_api
    extends:
      service: gateway_api
    profiles: ["network-gateway-image"]
    depends_on:
      database_migrations_image:
        condition: service_completed_successfully

  database_migrations_built:
    # NB - image: is defined in the base gateway_api
    extends:
      service: database_migrations
    profiles: ["network-gateway-built"]
    build: # build: takes higher priority over image:, so this allows us to capture all the config, but replace the image with a direct build
      context: "../"
      dockerfile: "./samples/DatabaseMigrations/Dockerfile"
    depends_on:
      postgres_db:
        condition: service_healthy

  data_aggregator_built:
    extends:
      service: data_aggregator
    profiles: ["network-gateway-built"]
    build: # build: takes higher priority over image:, so this allows us to capture all the config, but replace the image with a direct build
      context: "../"
      dockerfile: "./samples/DataAggregator/Dockerfile"
    depends_on:
      database_migrations_built:
        condition: service_completed_successfully

  gateway_api_built:
    extends:
      service: gateway_api
    profiles: ["network-gateway-built"]
    build: # build: takes higher priority over image:, so this allows us to capture all the config, but replace the image with a direct build
      context: "../"
      dockerfile: "./samples/GatewayAPI/Dockerfile"
    depends_on:
      database_migrations_built:
        condition: service_completed_successfully
